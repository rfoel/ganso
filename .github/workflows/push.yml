name: Push to any branch

on: push

jobs:
  lint:
    name: â¬£ ESLint
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ›‘ Cancel Previous Runs
        uses: styfle/cancel-workflow-action@0.11.0

      - name: â¬‡ï¸ Checkout repo
        uses: actions/checkout@v3

      - name: â” Setup node
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: ğŸ“¥ Download deps
        uses: bahmutov/npm-install@v1

      - name: ğŸ”¬ Lint
        run: npm run lint

  typecheck:
    name: Ê¦ TypeScript
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ›‘ Cancel Previous Runs
        uses: styfle/cancel-workflow-action@0.11.0

      - name: â¬‡ï¸ Checkout repo
        uses: actions/checkout@v3

      - name: â” Setup node
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: ğŸ“¥ Download deps
        uses: bahmutov/npm-install@v1

      - name: ğŸ” Type check
        run: npm run typecheck

  test-postgres:
    needs: [lint, typecheck]
    runs-on: ubuntu-latest
    env:
      DB_STRATEGY: 'postgres'
      POSTGRES_DB: 'db'
      POSTGRES_USER: 'postgres'
      POSTGRES_PASSWORD: 'ganso'
      POSTGRES_DB_URL: 'postgresql://postgres:ganso@localhost:5432/db'
      PORT: 3000
    services:
      postgres:
        image: postgres
        ports:
          - 5432:5432
        env:
          POSTGRES_DB: 'db'
          POSTGRES_USER: 'postgres'
          POSTGRES_PASSWORD: 'ganso'

    steps:
      - name: ğŸ›‘ Cancel Previous Runs
        uses: styfle/cancel-workflow-action@0.11.0

      - name: â¬‡ï¸ Checkout repo
        uses: actions/checkout@v3

      - name: â” Setup node
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: ğŸ“¥ Download deps
        uses: bahmutov/npm-install@v1

      - name: âš¡ Test
        run: npm run test:ci

  test-dynamo:
    needs: [lint, typecheck]
    runs-on: ubuntu-latest
    env:
      AWS_REGION: 'us-east-1'
      AWS_ACCESS_KEY_ID: abc123
      AWS_SECRET_ACCESS_KEY: abc123
      DB_STRATEGY: 'dynamo'
      DYNAMO_DB_URL: 'http://localhost:8000'
      PORT: 3000
    services:
      amazon/dynamodb-local:
        image: amazon/dynamodb-local
        ports:
          - 8000:8000

    steps:
      - name: ğŸ›‘ Cancel Previous Runs
        uses: styfle/cancel-workflow-action@0.11.0

      - name: â¬‡ï¸ Checkout repo
        uses: actions/checkout@v3

      - name: â” Setup node
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: ğŸ“¥ Download deps
        uses: bahmutov/npm-install@v1

      - name: âš¡ Test
        run: npm run test:ci
